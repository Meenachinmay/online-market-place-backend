# Referral Blog Service

A comprehensive microservices-based backend system built with Go, implementing an e-commerce platform with a referral blog and rewards system. This project demonstrates Clean Architecture, gRPC communication, and transactional integrity using PostgreSQL.

## ðŸ“‹ Table of Contents
- [Overview](#overview)
- [Key Features](#key-features)
- [Architecture](#architecture)
- [Tech Stack](#tech-stack)
- [Getting Started](#getting-started)
- [API Reference](#api-reference)

## ðŸš€ Overview

The Soda Interview Service simulates a backend for an online store ("Soda Store") where users can buy products, often discovered through referral blogs. The system incentivizes both buyers and content creators (blog authors) through a reward point system ("Soda Points") which can be converted into a digital currency ("Soda Balance").

## âœ¨ Key Features

### 1. Product Management
- Retrieve product details including pricing and reward configurations.
- List available products.

### 2. Referral Blog System
- Authors can create blogs linking to specific products.
- Tracks the relationship between content and products to attribute sales.

### 3. Order Processing & Rewards
- **Order Placement**: Securely processes orders linking Buyers, Products, and Referral Blogs.
- **Buyer Rewards**: Buyers earn **Soda Points** on their *first purchase* of a specific product.
- **Author Rewards**: Blog authors earn **Soda Points** for every sale generated through their referral blog.

### 4. Soda Finance (Wallet System)
- **Wallet Management**: Automatically creates and maintains wallets for users.
- **Points System**: Tracks accumulated Soda Points.
- **Currency Conversion**: Users can convert Soda Points to Soda Balance (Yen).
  - **Conversion Rule**: 2 Points = 1 Yen.
  - **Threshold**: Conversion is only allowed if the user has more than **1000 Soda Points**.

## ðŸ— Architecture

The project follows a **Clean/Hexagonal Architecture** to ensure separation of concerns and maintainability.

### 1. Protocol Layer (`foundation/proto`)
Defines the API contract using **Protocol Buffers (Protobuf)**.
- **Order Service**: `PlaceOrder`
- **Product Service**: `GetProduct`, `ListProducts`
- **Blog Service**: `CreateBlog`, `GetBlog`
- **Finance Service**: `GetWallet`, `ConvertPoints`

### 2. Transport Layer (`app/services/soda-interview-grpc`)
Contains the gRPC server implementation (`internal/transport/grpc`).
- **Handlers**: specific implementations (e.g., `order/handlers.go`) that map proto requests to business entities and call the core logic.

### 3. Business Core (`business/core`)
The heart of the application containing pure business logic.
- **Order Core**: Handles transaction orchestration, identifying first purchases, and triggering reward distribution.
- **Finance Core**: Enforces conversion rules (thresholds, rates) and manages wallet state.

### 4. Data Layer (`business/data`)
Handles database interactions.
- **Schema**: PostgreSQL migrations managed by `goose`.
- **Stores**: Type-safe SQL queries generated by `sqlc`.
- **Transactional Support**: Uses `pgxpool` for robust transaction management across multiple domain stores.

## ðŸ›  Tech Stack

- **Language**: [Go](https://go.dev/) (Golang)
- **Communication**: [gRPC](https://grpc.io/)
- **Database**: [PostgreSQL](https://www.postgresql.org/)
- **Database Driver**: [jackc/pgx](https://github.com/jackc/pgx)
- **SQL Generator**: [sqlc](https://sqlc.dev/)
- **Migrations**: [goose](https://github.com/pressly/goose)
- **Configuration**: [Viper](https://github.com/spf13/viper)
- **Containerization**: [Docker](https://www.docker.com/) & Docker Compose

## ðŸ Getting Started

### Prerequisites
- Go 1.21+
- Docker & Docker Compose
- Make

### Running the Application

1.  **Start Infrastructure**:
    Use Docker Compose to spin up the PostgreSQL database.
    ```bash
    make db-start
    ```

2.  **Run the Service**:
    You can run the gRPC server directly.
    ```bash
    make run
    ```
    Or via the Go command:
    ```bash
    go run app/services/soda-interview-grpc/main.go
    ```

3.  **Seed Data** (Optional but recommended):
    Check the `app/tooling/seed-data` directory or running the provided migration scripts to populate initial products and blogs.

### Running Tests

The project includes unit and integration tests.

```bash
go test ./...
```

## ðŸ“¡ API Reference

### Order Service (`order.v1`)
- `PlaceOrder`: Creates an order and triggers reward calculation.
  - Inputs: `buyer_id`, `product_id`, `blog_id`

### Finance Service (`soda_finance.v1`)
- `GetWallet`: Retrieves current points and balance.
- `ConvertPoints`: Converts points to balance if threshold (>1000) is met.
  - Rate: 2 Points -> 1 Yen

### Product Service (`product.v1`)
- `ListProducts`: Returns all available products.
- `GetProduct`: Returns details for a specific product ID.

### Referral Blog Service (`referral_blog.v1`)
- `CreateBlog`: Publishers create new content.
- `GetBlog`: Retrieve blog details.

---
*Generated for the Soda Interview Project.*
